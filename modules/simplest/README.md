# simple number increment

Aecor の動きが観察できる最小限のコードを、以下の要領で極力シンプルに書いてみた。

- ドメインモデルを極小にした
  - 負ではない整数を一つだけ保持する `Increment` をイベントソース対象のエンティティとした。
  - ゼロを生成する `Created` と、1 増加させる `Incremented` の二つだけをイベントとした。
- http の受け口などは敢えて作らず、ライトサイドとリードサイドは別々に起動するただの コンソールアプリとした。
  - ライトサイドは、`Created` イベント一つ発生させる `ZeroMain` と、 指定されたエンティティへの`Incremented` イベントを発生させる`IncMain`の二つ。
  - リードサイドは、ジャーナルの更新を待ち受けながら、オンメモリで保持するビュー（この例ではただの Scala データ）を更新し続ける `ReaderMain`。

## 事前準備

- ローカル環境で postgres を起動しておく。Docker でも何でも良い。
  - db name : increment
  - username: postgres
  - password: (なし)

テーブル定義などは不要。

## 動作について

### ライトサイド
`ZeroMain` も `IncMain` も、それぞれイベントを一つだけ発生させて終了する。Aecor はイベントをジャーナルに追加する。

- `ZeroMain` を実行すると、`Created` イベントを発生させ、新しい ID に関連付けて、ジャーナルに保存する。
- `IncMain` に ID を与えて実行すると、`Incremented` イベントを発生させ、与えられた ID に関連付けてジャーナルに保存する。

ジャーナルは、上述の Postgres データベース内のテーブルになるが、テーブル名だけ指定しておくと、存在しない場合は Aecor がよしなに作成するので、特にDDLなどを書く必要はない。ここでは `increment_event`を指定した。

### リードサイド
リードサイドではジャーナルの他に、どこまで読み込んだかを記録しておくオフセットストアも関連する。

- `ReaderMain`を起動すると、Aecor がジャーナルとオフセットストアを照らし合わせて、ビューの現在の状態を初期値として未読イベントのストリームを畳み込もうとするので、アプリケーションでは畳み込み演算を提供する。
- 一般的に畳み込んだ新しい状態は、永続化層などに保存されるが、このサンプルでは簡単のためメモリ上の可変Map に保持している。簡単のためにあえてオンメモリの `mutable.Map` とした。
- ストリーム末尾まで畳み込むと待ち状態になるが、この状態でライトサイドの `ZeroMain` や `IncMain` をさらに追加実行すると、ビューの現在状態に新たにイベントが一つ畳み込まれ更新される。
- オフセットストアもその都度更新されていく。
- [ENTER]を入力すると `ReaderMain` は終了する。



