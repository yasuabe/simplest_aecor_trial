# simple number sum 

Aecor の動きが観察できる最小限のコードを、以下の要領で極力シンプルに書いてみた。

- ドメインモデルを極小にした
  - 整数の合計を保持する `Sum` をイベントソース対象のエンティティとした。
  - ゼロを生成する `Created` と、数を加算する `Added` の二つだけをイベントとした。
- http の受け口などは敢えて作らず、ライトサイドとリードサイドを別々に起動する、ただの コンソールアプリとした。
  - ライトサイドは、`Created` イベントを一つ発生させる `ZeroMain` と、 指定されたエンティティへの`Added` イベントを発生させる`AddMain`の二つ。
  - リードサイドは、ジャーナルの更新を待ち受けながら、オンメモリで保持するビュー（この例ではただの Scala データ）を更新し続ける `ReaderMain`。

## 事前準備

- ローカル環境で postgres を起動しておく。Docker でも何でも良い。
  - db name : sumdb 
  - username: postgres
  - password: (なし)

テーブル定義などは不要。

## 動作について

### ライトサイド
`ZeroMain` も `AddMain` も、それぞれイベントを一つだけ発生させて終了する。Aecor はイベントをジャーナルに追加する。

- `ZeroMain` を実行すると、`Created` イベントを発生させ、新しい ID に関連付けて、ジャーナルに保存する。
- `AddMain` に ID を与えて実行すると、`Incremented` イベントを発生させ、与えられた ID に関連付けてジャーナルに保存する。

ジャーナルは、上述の Postgres データベース内のテーブルになるが、Scala コード内でテーブル名だけ指定しておくと、存在しない場合には Aecor が必要なスキーマでよしなに作成するので、特にDDLなどを書く必要はない。ここではジャーナルテーブル名として `sum_event`を指定した。

### リードサイド
リードサイドではジャーナルの他に、どこまで読み込んだかを記録しておくオフセットストアも関連する。

- `ReaderMain`を起動すると、Aecor はジャーナルとオフセットストアを照らし合わせ、ビューの現在状態を初期値として未読イベントのストリームを畳み込もうとする。アプリケーションでは具体的な畳み込み演算を提供することになる。
- 畳み込み得られた新状態は一般的に永続化層などに保存されるが、このサンプルでは簡単のためメモリ上の可変Map に保持している。簡単のためにあえてオンメモリの `mutable.Map` とした。
- ストリーム末尾まで畳み込むと待ち状態になるが、この状態でライトサイドの `ZeroMain` や `AddMain` をさらに追加実行すると、ストリームに新たに流れてきたイベントが現在状態のビューに畳み込まれ、ビューが更新される。オフセットストアもその都度更新されていく。
- ジャーナルと同様、オフセットストアもテーブル名だけ指定しておけば、存在しない場合には Aecor が適当なスキーマで作成する。ここでは `consumer_offset` というテーブル名にした。
- [ENTER]を入力すると `ReaderMain` は終了する。

## 試行
例えば、以下のようにライトサイド、リードサイドを起動したとする。

- `ReaderMain` を起動すると、立ち上がったままイベントを待っている状態になる。初回起動であればジャーナルとオフセットの二つのテーブルもこの時点で生成する。
- `CreateMain` を起動すると、`ReaderMain` 側のログに `Created` イベントが出力される。このログには `Sum` エンティティのIDも含まれている。
- `AddMain` に、`CreatedMain` で出力された ID と適当な数字、（たとえば、13 や 7など）を、プログラム引数として指定して起動すると、`ReaderMain` 側のログに `Added` イベントが出力される。

下のようなログになる。

```
Event: EntityEvent(SumKey(28d67455-897e-4bc6-8df2-eab696131505),1,Created), Updated: Version(1), Some(SumView(SumKey(28d67455-897e-4bc6-8df2-eab696131505),0,1))
Event: EntityEvent(SumKey(28d67455-897e-4bc6-8df2-eab696131505),2,Added(1)), Updated: Version(2), Some(SumView(SumKey(28d67455-897e-4bc6-8df2-eab696131505),1,2))
Event: EntityEvent(SumKey(28d67455-897e-4bc6-8df2-eab696131505),3,Added(13)), Updated: Version(3), Some(SumView(SumKey(28d67455-897e-4bc6-8df2-eab696131505),14,3))
Event: EntityEvent(SumKey(28d67455-897e-4bc6-8df2-eab696131505),4,Added(7)), Updated: Version(4), Some(SumView(SumKey(28d67455-897e-4bc6-8df2-eab696131505),21,4))
```
